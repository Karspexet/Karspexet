{% extends "ticket/base.html" %}
{% load tz static %}
{% block ticket_content %}
  <div class="content_container">
    <section class="contact-details pb-4">
      <h2 class="uppercase text-center">Bokning</h2>

      <table class="p-3 bg-black bg-red-darker w-full rounded-md text-left">
        <tr>
          <th class="text-sm text-gold w-32 p-1">FÖRESTÄLLNING</th>
          <td>{{ reservation.show }}</td>
        </tr>
        <tr>
          <th class="text-sm text-gold w-32 p-1">ANTAL BILJETTER</th>
          <td>{{ num_tickets }}</td>
        </tr>
        {% if reservation.discount %}
          <tr>
            <th class="text-sm text-gold w-32 p-1">PRESENTKORT</th>
            <td class="w-100">{{ reservation.discount.voucher.code }}</td>
          </tr>
        {% endif %}
        <tr>
          <th class="text-sm text-gold w-32 p-1">PLATSER</th>
          <td>
            <ul>
              {% for seat in seats %}
                <li>
                  {{ seat.0 }}
                  <span class="text-gray-200">(à {{ seat.2 }} SEK)</span>
                </li>
              {% endfor %}
            </ul>
          </td>
        </tr>
      </table>

      <p class="fn-session-timeout text-sm text-gray-200">
        Din reservation är giltig till
        <time data-time="{{reservation.session_timeout|date:'c'}}">{{ reservation.session_timeout|date:"H:i" }}</time>
        (<span class="fn-session-timeout-output">30 minuter</span> kvar)
      </p>

      {% if payment_failed %}
        <div>
          <span class="payment-error-message">Betalningen gick inte igenom. Försök igen.</span>
        </div>
      {% endif %}

      <div>
        <p>Var det en av våra medlemmar som fick dig att köpa dina biljetter? Fyll i så fall gärna i dess namn som referens!</p>
        <div class="form-group">
          <label>
            <span>Referens</span>
            <input type="text" class="field" name="reference" autocomplete="name"/>
          </label>
        </div>
      </div>

      <h2>Betalning / Presentkort</h2>

      <p>För att betala dina biljetter, fyll i dina kortuppgifter här nedanför.</p>
      <p>Tänk på att du kan behöva låsa upp ditt kort för internetbetalningar!</p>

      {% if not reservation.discount %}
        <button id="enter-discount-code">Presentkort</button>
      {% endif %}

      <div id="discount-form" class="hidden" data-discount-code="{{ reservation.discount.voucher.code }}">
        <button id="cancel-discount">Tillbaka</button>

        <p>Om du har ett presentkort måste du använda den innan du kan betala. Detta för att vi behöver räkna om ditt biljettpris efter att du valt att använda din presentkortskod. Annars kommer du betala hela biljettpriset.</p>

        <p>För att använda ett presentkort, fyll i koden nedan och klicka sedan på "Använd Presentkort"</p>

        <form method="POST" action="{% url "apply_voucher" reservation.id %}" class="payment-form" id="discount-form">
          {% csrf_token %}
          <div class="group">
            <label>
              <span>Presentkort</span>
              <input type="text" class="field" name="voucher_code"/>
            </label>
          </div>
          <button type="submit">Använd presentkort!</button>
        </form>
      </div>

      <form action="{% url "process_payment" reservation.id %}" method="post" id="payment-form" class="payment-form" {% if reservation.is_free %}data-is-free{% endif %}>
        {% csrf_token %}
        <div class="group">
          <label>
            <span>Namn</span>
            <input name="name" class="field" placeholder="Frank Hamer" autocomplete="name" required/>
          </label>
          <label>
            <span>Telefonnummer</span>
            <input name="phone" class="field" placeholder="070-1740605" type="tel" autocomplete="tel"/>
          </label>
          <label>
            <span>E-postadress</span>
            <input name="email" class="field" placeholder="" type="email" autocomplete="email" required/>
          </label>
        </div>

        <p>Din e-post används endast för att skicka bokningsbekräftelse och information gällande föreställningen.</p>

        <div class="bg-red-darker p-4 my-4 rounded">
          <h2 class="p-0 m-0 pb-2">Avbokningsregler
            <svg class="w-4 float-right text-gold" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
              <path fill="currentColor" d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/></svg>
          </h2>
          <p class="p-0 m-0">
            Om Covid-restriktionen för evenemang av den här typen sänks till under nuvarande 300 personer
            kommer evenemanget att ställas in. Om detta sker efter 1/10 kommer tyvärr inte några biljetter
            att återbetalas pga de avtal vi har med biografen. Hoppas ni har överseende med detta.
          </p>
        </div>

        {% include payment_partial %}

        <button class="fn-payment-submit-button" type="submit">Betala {{ reservation.total }} kr</button>
        <div class="spinner-container hidden">
          <span>Vänta medan vi behandlar din betalning...</span>
          <img class="luva spinner" src="{% static 'svg/luva-inkscape.svg' %}" alt="">
        </div>
        <div class="outcome">
          <div class="error" role="alert"></div>
        </div>
      </form>

      <div>
        <form method="post" action="{% url 'cancel_reservation' reservation.show.id %}">
          {% csrf_token %}
          <span>eller</span>
          <input type="submit" id="cancel-reservation-button" value="Avbryt bokningen">
          <div id="fn-payment-errors"></div>
        </form>
      </div>
    </section>

    {% if reservation.total > 0 %}
      <script>
        window.config = window.config || {}
        window.config.stripeKey = '{{ stripe_key }}'
        window.config.clientSecret = '{{ stripe_payment_indent.client_secret }}'
        window.config.successUrl = '{{ reservation.get_absolute_url }}'
      </script>
    {% endif %}
  </div>
{% endblock %}
